name: Build GL-MT3000 Minimal Fast

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 清理磁盘空间
        run: |
          echo "清理磁盘空间..."
          sudo rm -rf /opt/hostedtoolcache /usr/local/lib/android /usr/share/dotnet
          sudo rm -rf /home/runner/work/_temp /home/runner/work/_actions
          df -h

      - name: 安装依赖
        run: |
          echo "安装构建依赖..."
          sudo apt update
          sudo apt install -y build-essential git python3 rsync unzip \
            libncurses5-dev zlib1g-dev gawk flex gettext libssl-dev wget
          df -h  # 再次查看磁盘空间，确保有足够空间

      - name: 克隆 ImmortalWrt
        run: |
          echo "克隆 ImmortalWrt 仓库..."
          git clone https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          git checkout master  # 如果需要特定分支，可以在此修改
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 写入配置
        run: |
          echo "写入配置文件..."
          cd immortalwrt
          cat > .config <<'EOF'
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_glinet_gl-mt3000=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-ssl=y
          CONFIG_PACKAGE_ip-full=y
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_ca-certificates=y
          CONFIG_PACKAGE_kmod-mt7981-firmware=y
          CONFIG_PACKAGE_kmod-mt7915e=y
          CONFIG_PACKAGE_hostapd-common=y
          CONFIG_PACKAGE_wpad-basic-mbedtls=y
          CONFIG_PACKAGE_igmpproxy=y
          CONFIG_PACKAGE_luci-app-openclash=y
          EOF
          yes "" | make defconfig

      - name: 预下载依赖
        run: |
          echo "预下载依赖..."
          cd immortalwrt
          make download -j8

      - name: 编译固件
        run: |
          echo "开始编译固件..."
          cd immortalwrt
          make -j$(nproc) || make -j1 V=s  # 若多核编译失败，使用单核编译
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp -r bin/targets/*/* $GITHUB_WORKSPACE/artifacts/

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: gl-mt3000-minimal
          path: artifacts

      - name: 清理缓存
        run: |
          echo "清理缓存..."
          sudo rm -rf $GITHUB_WORKSPACE/immortalwrt
