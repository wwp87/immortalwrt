name: Build GL-MT3000 Minimal

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 清理磁盘空间（释放 20GB+）
        run: |
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /home/runner/work/_temp
          sudo rm -rf /home/runner/work/_actions
          df -h

      - name: 安装依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential git python3 rsync unzip \
            libncurses5-dev zlib1g-dev gawk flex gettext libssl-dev wget

      - name: 克隆 ImmortalWrt
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 写入配置（不依赖外部 .config）
        run: |
          cd immortalwrt
          cat > .config <<'EOF'
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_glinet_gl-mt3000=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-ssl=y
          CONFIG_PACKAGE_ip-full=y
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_ca-bundle=y
          CONFIG_PACKAGE_ca-certificates=y
          CONFIG_PACKAGE_kmod-mt7981-firmware=y
          CONFIG_PACKAGE_kmod-mt7915e=y
          CONFIG_PACKAGE_hostapd-common=y
          CONFIG_PACKAGE_wpad-basic-mbedtls=y
          CONFIG_PACKAGE_igmpproxy=y
          CONFIG_PACKAGE_smcroute=y
          CONFIG_PACKAGE_udpxy=y
          CONFIG_PACKAGE_luci-app-openclash=y
          CONFIG_PACKAGE_tcpdump=y
          CONFIG_PACKAGE_htop=y
          CONFIG_PACKAGE_curl=y
          EOF
          yes "" | make defconfig

      - name: 编译固件（串行 + 显示详细日志）
        run: |
          cd immortalwrt
          make -j1 V=s
          mkdir -p $GITHUB_WORKSPACE/artifacts
          cp -r bin/targets/*/* $GITHUB_WORKSPACE/artifacts/

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: gl-mt3000-minimal
          path: artifacts
